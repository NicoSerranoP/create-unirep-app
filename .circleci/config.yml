version: 2.1
workflows:
    test:
        jobs:
            - contracts-test
            - deploy:
                context: docker
                filters:
                    branches:
                        only:
                            - main
                            - beta-3

# Just for reusing below
step_defs:
    - run: &node_version
          name: Set Node version
          command: |
              nvm install v16
              nvm alias default v16
              echo "nvm use default" >> $BASH_ENV
    - run: &check_version
          name: Check Node version
          command: node -v | grep v16

jobs:
    contracts-test:
        resource_class: medium
        machine:
            image: ubuntu-2204:2022.04.1
        steps:
            - checkout
            - run: *node_version
            - run: *check_version
            - run:
                  name: Install Packages
                  command: yarn
            - run:
                  name: Test
                  command: yarn contracts test
    deploy:
        machine:
            image: ubuntu-2204:2022.04.1
        resource_class: large
        steps:
            - checkout
            - run: *node_version
            - run: *check_version
            - run:
                name: Install
                command: yarn
            - run:
                name: Build backend image
                command: |
                    echo "module.exports = {}" > config.js
                    docker build . -t jchancehud/unirep-demo-relay:latest
            - run:
                name: Push backend image
                command: |
                    echo $DOCKER_TOKEN | docker login -u jchancehud --password-stdin
                    docker push jchancehud/unirep-demo-relay:latest
                    rm /home/circleci/.docker/config.json
